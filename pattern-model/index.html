<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR.js with Three.js</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.js"></script>
    <script type="importmap">
        {
          "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@latest/build/three.module.js"
          }
        }
    </script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #hidden-video {
            display: none;
        }
    </style>
</head>

<body>
    <!-- Hidden Video Element -->
    <video id="hidden-video" src="../assets/ar/WhatsApp Video 2024-12-30 at 03.38.20.mp4" muted loop playsinline autoplay>
    </video>

    <!-- AR.js Scene -->
    <a-scene vr-mode-ui='enabled: false;' embedded arjs='trackingMethod: best;'>
        <!-- Marker -->
        <a-marker id="marker" preset="custom" type="pattern" url="../assets/ar/pattern-Untitled.patt" smooth="true"
            smoothCount="0" smoothTolerance="0.0005" smoothThreshold="1.5" preload="true">
            <!-- Placeholder object -->
            <a-entity id="pseudo-object" geometry="primitive: box; height: 0.01; width: 0.01; depth: 0.01"
                material="color: transparent" position="0 0.05 3"></a-entity>

            <!-- Video Entity -->
            <a-video id="video-plane" src="#hidden-video" position="0 0 0" rotation="0 0 0" scale="1 1 1"></a-video>

        </a-marker>


        <a-entity light="type: ambient; color: #404040; intensity: 50"></a-entity>
        <a-entity camera></a-entity>
    </a-scene>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';

        window.addEventListener('DOMContentLoaded', () => {
            console.log('AR.js and Three.js are ready.');

            const pseudoObject = document.querySelector('#pseudo-object');
            const videoPlane = document.querySelector('#video-plane');

            // Set up Three.js scene
            const scene = pseudoObject.object3D;
            const loader = new GLTFLoader();

            let mixer; // For animations
            let model; // To store the loaded model
            let plane; // Reference to the plane object in the model

            // Add lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 200);
            scene.add(ambientLight);

            // Load the GLB model
            loader.load('/assets/ar/ironman-animation_final-2.glb', (gltf) => {
                model = gltf.scene;

                // Find the plane object in the model
                plane = model.getObjectByName('Plane'); // Adjust the name if different in your model

                model.position.set(0, 0, 0); // Adjust relative position
                model.scale.set(0.2, 0.2, 0.2); // Adjust scale if needed
                scene.add(model);

                // Animation mixer setup
                if (gltf.animations && gltf.animations.length) {
                    mixer = new THREE.AnimationMixer(model);
                    gltf.animations.forEach((clip) => {
                        const action = mixer.clipAction(clip);
                        action.setLoop(THREE.LoopOnce); // Stop looping the animation
                        action.clampWhenFinished = true; // Keep the last frame when the animation ends
                        action.play();
                    });
                }
            }, undefined, (error) => {
                console.error('An error occurred while loading the model:', error);
            });

            // Animation loop
            const clock = new THREE.Clock();
            function animate() {
                requestAnimationFrame(animate);

                // Update the animation mixer
                if (mixer) {
                    const delta = clock.getDelta();
                    mixer.update(delta);
                }

                // Sync the A-Frame video plane with the model's plane object
                if (plane && videoPlane) {
                    const position = new THREE.Vector3();
                    const rotation = new THREE.Euler();
                    const scale = new THREE.Vector3();

                    plane.getWorldPosition(position);
                    plane.getWorldQuaternion(rotation.setFromQuaternion(plane.getWorldQuaternion(new THREE.Quaternion())));
                    plane.getWorldScale(scale);

                    videoPlane.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
                    videoPlane.setAttribute('rotation', `${THREE.MathUtils.radToDeg(rotation.x)} ${THREE.MathUtils.radToDeg(rotation.y)} ${THREE.MathUtils.radToDeg(rotation.z)}`);
                    videoPlane.setAttribute('scale', `${scale.x} ${scale.y} ${scale.z}`);
                }
            }

            animate();
        });
    </script>
</body>

</html>